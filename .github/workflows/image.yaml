name: MIG Rollout from VM Snapshot

on:
  push:
    branches:
      - main

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Checkout repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2. Authenticate with Workload Identity Federation
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: projects/515228593779/locations/global/workloadIdentityPools/wp-test/providers/wp-test
          service_account: wp-test@micro-answer-469207-r4.iam.gserviceaccount.com

      # 3. Setup gcloud
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # 4. Capture current template (for rollback)
      - name: Capture Current Template
        id: old_template
        run: |
          OLD_TEMPLATE=$(gcloud compute instance-groups managed describe wp-mig \
            --zone=us-central1-c \
            --format="value(instanceTemplate)")
          echo "old_template=$OLD_TEMPLATE" >> $GITHUB_OUTPUT

      # 5. Pick one VM from MIG
      - name: Select MIG VM
        id: pick_vm
        run: |
          INSTANCE=$(gcloud compute instance-groups managed list-instances wp-mig \
            --zone=us-central1-c --format="value(instance)" | head -n1)
          echo "instance=$INSTANCE" >> $GITHUB_OUTPUT

      # 6. Snapshot VM into image
      - name: Snapshot MIG VM
        id: snapshot
        run: |
          IMAGE_NAME="wp-snapshot-$(date +%Y%m%d%H%M%S)"
          gcloud compute images create $IMAGE_NAME \
            --source-disk=${{ steps.pick_vm.outputs.instance }} \
            --source-disk-zone=us-central1-c
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT

      # 7. Create new template (clone base + new boot disk image)
      - name: Create New Template
        id: template
        run: |
          BASE_TEMPLATE="wp-test-template"
          NEW_TEMPLATE="wp-template-$(date +%Y%m%d%H%M%S)"

          gcloud compute instance-templates create $NEW_TEMPLATE \
            --source-instance-template=$BASE_TEMPLATE \
            --boot-disk-image=${{ steps.snapshot.outputs.image }}

          echo "template=$NEW_TEMPLATE" >> $GITHUB_OUTPUT

      # 8. Update MIG to use new template + rollout
      - name: Rollout MIG
        id: rollout
        continue-on-error: true
        run: |
          gcloud compute instance-groups managed set-instance-template wp-mig \
            --zone=us-central1-c \
            --template=${{ steps.template.outputs.template }}

          gcloud compute instance-groups managed rolling-action replace wp-mig \
            --zone=us-central1-c \
            --max-surge=1 \
            --max-unavailable=0

      # 9. Rollback if rollout failed
      - name: Rollback MIG
        if: steps.rollout.outcome == 'failure'
        run: |
          echo "⚠️ Rollout failed, rolling back to previous template..."
          gcloud compute instance-groups managed set-instance-template wp-mig \
            --zone=us-central1-c \
            --template=${{ steps.old_template.outputs.old_template }}

          gcloud compute instance-groups managed rolling-action replace wp-mig \
            --zone=us-central1-c \
            --max-surge=1 \
            --max-unavailable=0
